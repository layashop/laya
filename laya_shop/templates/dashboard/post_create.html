{% extends 'dashboard/layouts/base.html' %}

{% load widget_tweaks static %}
{% block title %} Dashboard {% endblock title %}

{% block content %}



<div class="mx-10 pt-20">
    {% for field in form.visible_fields %}
        {% for error in field.errors %}
            <div class="flex items-center bg-red-500 text-white text-sm font-bold px-4 py-3" role="alert">
                <svg class="fill-current w-4 h-4 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M12.432 0c1.34 0 2.01.912 2.01 1.957 0 1.305-1.164 2.512-2.679 2.512-1.269 0-2.009-.75-1.974-1.99C9.789 1.436 10.67 0 12.432 0zM8.309 20c-1.058 0-1.833-.652-1.093-3.524l1.214-5.092c.211-.814.246-1.141 0-1.141-.317 0-1.689.562-2.502 1.117l-.528-.88c2.572-2.186 5.531-3.467 6.801-3.467 1.057 0 1.233 1.273.705 3.23l-1.391 5.352c-.246.945-.141 1.271.106 1.271.317 0 1.357-.392 2.379-1.207l.6.814C12.098 19.02 9.365 20 8.309 20z"/></svg>
                <p>Error en {{field.label}}:  {{ error|escape }}</p>
            </div>
            <!-- <span class="help-block">{{ error }}</span> -->
        {% endfor %}
    {% endfor %}
    <form class="flex flex-col" action="{{request.path}}" method="POST" enctype="multipart/form-data" id="post-create">
        <div class="w-full create-form">
            <div class="bg-white px-4 py-4 info-form rounded-md shadow">
                {% csrf_token %}
                <div class="flex flex-wrap -mx-3 mb-3">
                    <div class="w-full px-3">
                        <label class="block uppercase tracking-wide text-gray-700 text-xs font-bold mb-2"
                        for="{{form.title.auto_id}}">Titulo</label>
                        <p class="text-red-500 text-xs italic">Requerido</p>
                        {% render_field form.title class+="appearance-none block w-full bg-gray-200 text-gray-700 border border-red-500 rounded py-3 px-4 mb-3 leading-tight focus:outline-none focus:bg-white" %}

                    </div>
                </div>
                <div class="flex flex-wrap -mx-3 mb-3">
                    <div class="w-1/2 px-3">
                        <label class="block uppercase tracking-wide text-gray-700 text-xs font-bold mb-2"
                        for="{{form.price.auto_id}}">Precio</label>
                        <p class="text-red-500 text-xs italic">Requerido</p>
                        {% render_field form.price class+="appearance-none block w-full bg-gray-200 text-gray-700 border border-red-500 rounded py-3 px-4 mb-3 leading-tight focus:outline-none focus:bg-white" %}
                    </div>
                    <div class="w-1/2  px-3">
                          <label class="block uppercase tracking-wide text-gray-700 text-xs font-bold mb-2"
                          for="{{form.currency.auto_id}}">Moneda</label>
                          <p class="text-red-500 text-xs italic">Requerido</p>
                          {% render_field form.currency class+="appearance-none block w-full bg-gray-200 text-gray-700 border border-red-500 rounded py-3 px-4 mb-3 leading-tight focus:outline-none focus:bg-white" %}
                      </div>
                </div>
                <div class="flex flex-wrap -mx-3 mb-3">
                    <div class="w-1/2 px-3">
                        <label class="block uppercase tracking-wide text-gray-700 text-xs font-bold mb-2"
                        for="{{form.state.auto_id}}">Estado</label>
                        <p class="text-red-500 text-xs italic">Requerido</p>
                        {% render_field form.state class+="appearance-none block w-full bg-gray-200 text-gray-700 border border-red-500 rounded py-3 px-4 mb-3 leading-tight focus:outline-none focus:bg-white" %}

                    </div>
                </div>
                <div class="flex flex-wrap -mx-3 mb-6">
                    <div class="w-full px-3">
                        <label class="block uppercase tracking-wide text-gray-700 text-xs font-bold mb-2"
                            for="{{form.description.auto_id}}">Description</label>
                        {% render_field form.description rows="10" cols="20" class+="appearance-none block w-full bg-gray-200 text-gray-700 border border-gray-200 rounded py-3 px-4 mb-3 leading-tight focus:outline-none focus:bg-white focus:border-gray-500" %}
                        <p class="text-gray-600 text-xs italic">Make it as long and as crazy as you'd like</p>
                    </div>
                </div>
                <div class="flex flex-wrap -mx-3 mb-2">
                    <div class="w-full px-3 mb-6 md:mb-0">
                        <label class="block uppercase tracking-wide text-gray-700 text-xs font-bold mb-2"
                            for="{{form.title.auto_id}}">Promocion</label>
                        {% render_field form.promo class+="appearance-none block w-full bg-gray-200 text-gray-700 border border-gray-200 rounded py-3 px-4 leading-tight focus:outline-none focus:bg-white focus:border-gray-500" %}
                    </div>
                </div>
                <div class="flex flex-wrap -mx-3 mb-2">
                    <div class="w-full md:w-1/3 px-3 mb-6 md:mb-0">
                        <label class="block uppercase tracking-wide text-gray-700 text-xs font-bold mb-2"
                            for="{{form.title.auto_id}}">Descuento</label>
                        {% render_field form.discount class+="appearance-none block w-full bg-gray-200 text-gray-700 border border-gray-200 rounded py-3 px-4 leading-tight focus:outline-none focus:bg-white focus:border-gray-500" %}
                    </div>
                    <div class="w-full md:w-1/3 px-3 mb-6 md:mb-0">
                        <label class="block uppercase tracking-wide text-gray-700 text-xs font-bold mb-2"
                            for="{{form.title.auto_id}}">Estado</label>
                        {% render_field form.status class+="appearance-none block w-full bg-gray-200 text-gray-700 border border-gray-200 rounded py-3 px-4 leading-tight focus:outline-none focus:bg-white focus:border-gray-500" %}
                    </div>
                </div>
            </div>
            <div class="bg-white w-auto images-form rounded-md shadow px-3 py-4">
                <div id="category-select"></div>
            </div>
        </div>
        <div class="bg-white w-full images-form rounded-md shadow post-images py-2 px-10 mt-5">
            <div id="dropzone-widget" class="w-full dropzone">
            </div>
        </div>
        <button class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded ml-auto mt-3">Guardar</button>
    </form>
</div>
{% endblock %}

{% block javascripts %}

<script>

    const CATEGORIES = {{json_categories|safe}}
</script>

<script src="{% static 'dist/js/DashboardPostSelectCategory.js' %}"></script>

<script>
    let validPostImagesIds = []
    Dropzone.autoDiscover = false;
    let csrftoken = Cookies.get('csrftoken');

    var myDropzone = new Dropzone("#dropzone-widget", {
        url: "{% url 'api_posts:temp_image' %}?business={{business.slug}}",
        withCredentials: true,
        acceptedFiles: "image/jpeg,image/png,image/gif",
        maxFiles: 3,
        paramName: 'image',
        thumbnailWidth: '300',
        addRemoveLinks: true,
        dictRemoveFile: "Borrar",
        dictCancelUploadConfirmation: "Estas seguro?",
        headers: {
            'X-CSRFToken': csrftoken
        },
        init: function(){
            this.on("success",  function(file, response){
                validPostImagesIds.push(response)
                file.id = file.id || response
                file.previewElement.classList.add("dz-success");
                return
            })
        },
        removedfile: function(file){
            let url = "{% url 'api_posts:temp_image' %}"
            let removeElementId = file.id
            console.log(file)
            fetch(url + removeElementId, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': csrftoken
                }}).then(response => {
                    validPostImagesIds = validPostImagesIds.filter(element => element != removeElementId)

                    file.previewElement.remove()
                })
            }
    });

</script>



<script>
    $('#post-create').submit(function() {
        for (let id of validPostImagesIds){
            $('<input type="text">').attr({name: "images", value: id }).appendTo($(this))
        }
    });
</script>

{% endblock javascripts %}
